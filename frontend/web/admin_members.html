<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin — Membres</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container layout">
    <aside class="sidebar">
      <h2 class="brand">DONS Admin</h2>
      <nav>
        <a href="dashboard.html">Tableau de bord</a>
        <a href="admin_groups.html">Groupes</a>
        <a class="active" href="admin_members.html">Membres</a>
        <a href="admin_exports.html">Exports</a>
        <a href="admin_payments.html">Paiements</a>
      </nav>
    </aside>
    <div class="content card">
      <div class="header">
        <h1 class="title">Membres</h1>
      </div>
      <div class="grid">
        <form id="create" class="grid grid-2">
          <div>
            <label for="first_name">Prénom</label>
            <input id="first_name" required>
          </div>
          <div>
            <label for="last_name">Nom</label>
            <input id="last_name" required>
          </div>
          <div>
            <label for="phone_number">Téléphone</label>
            <input id="phone_number" required>
          </div>
          <div>
            <label for="email">Email (optionnel)</label>
            <input id="email" type="email">
          </div>
          <div class="row" style="grid-column:1 / -1">
            <button type="submit">Créer le membre</button>
            <span id="msg" class="muted"></span>
          </div>
        </form>
        <div class="row">
          <select id="groupSelect"></select>
          <button id="addToGroup">Ajouter au groupe</button>
          <button id="removeFromGroup" class="btn-danger">Retirer du groupe</button>
        </div>
        <table class="table" id="table">
          <thead><tr><th>ID</th><th>Nom</th><th>Téléphone</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="error" class="muted" style="color:#ef4444"></div>
      </div>
    </div>
  </div>
  <script src="api.js"></script>
  <script>
    const tbody = document.querySelector('#table tbody');
    const groupSelect = document.getElementById('groupSelect');
    const errorEl = document.getElementById('error');
    const msg = document.getElementById('msg');
    let selectedMemberId = null;

    async function load(){
      errorEl.textContent=''; tbody.innerHTML='';
      try{
        const [members, groups] = await Promise.all([
          DonsApi.AdminApi.listMembers(),
          DonsApi.AdminApi.availableGroups()
        ]);
        groupSelect.innerHTML = (groups?.data || groups || []).map(g=>`<option value="${g.id}">${g.name||g.nom||('Groupe '+g.id)}</option>`).join('');
        (members?.data || members || []).forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${m.id||''}</td><td>${m.first_name||''} ${m.last_name||''}</td><td>${m.phone_number||''}</td>`;
          tr.addEventListener('click', ()=>{ selectedMemberId = m.id; [...tbody.children].forEach(r=>r.style.background=''); tr.style.background='#fee2e2'; });
          tbody.appendChild(tr);
        });
      }catch(e){ errorEl.textContent = e?.data?.message || e.message; }
    }

    document.getElementById('create').addEventListener('submit', async(e)=>{
      e.preventDefault(); msg.textContent='';
      try{
        await DonsApi.AdminApi.createMember({
          first_name: document.getElementById('first_name').value,
          last_name: document.getElementById('last_name').value,
          phone_number: document.getElementById('phone_number').value,
          email: document.getElementById('email').value || null,
        });
        msg.textContent='Créé.'; await load();
      }catch(e){ msg.textContent = e?.data?.message || e.message; }
    });

    document.getElementById('addToGroup').addEventListener('click', async()=>{
      if(!selectedMemberId) return alert('Sélectionnez un membre (cliquez sur une ligne).');
      try{ await DonsApi.AdminApi.addToGroup({ member_id: selectedMemberId, group_id: groupSelect.value }); await load(); }catch(e){ alert(e?.data?.message||e.message); }
    });
    document.getElementById('removeFromGroup').addEventListener('click', async()=>{
      if(!selectedMemberId) return alert('Sélectionnez un membre.');
      try{ await DonsApi.AdminApi.removeFromGroup({ member_id: selectedMemberId, group_id: groupSelect.value }); await load(); }catch(e){ alert(e?.data?.message||e.message); }
    });

    load();
  </script>
</body>
</html>


