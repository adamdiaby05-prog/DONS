<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tableau de bord — DONS Admin</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container layout">
    <aside class="sidebar">
      <h2 class="brand">DONS Admin</h2>
      <nav>
        <a class="active" href="dashboard.html">Tableau de bord</a>
        <a href="admin_groups.html">Groupes</a>
        <a href="admin_members.html">Membres</a>
        <a href="admin_exports.html">Exports</a>
        <a href="admin_payments.html">Paiements</a>
        <a href="#" id="logout">Se déconnecter</a>
      </nav>
    </aside>
    <div class="content card">
      <div class="header">
        <h1 class="title">Tableau de bord</h1>
      </div>
      <div class="toolbar">
        <div class="row" style="gap:8px">
          <select id="status">
            <option value="">Tous statuts</option>
            <option value="pending">En attente</option>
            <option value="success">Réussi</option>
            <option value="failed">Échoué</option>
          </select>
          <select id="method">
            <option value="">Toutes méthodes</option>
            <option value="orange_money">Orange Money</option>
            <option value="mtn_money">MTN Money</option>
            <option value="airtel_money">Airtel Money</option>
            <option value="mobile_money">Mobile Money</option>
          </select>
          <button id="refresh">Actualiser</button>
        </div>
        <div id="me" class="muted">Chargement du profil...</div>
      </div>

      <div id="table-wrap" class="grid">
        <table class="table" id="payments">
          <thead>
            <tr>
              <th>Référence</th>
              <th>Montant</th>
              <th>Méthode</th>
              <th>Téléphone</th>
              <th>Statut</th>
              <th>Groupe</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <button id="prev">Précédent</button>
        <div id="pageInfo" class="muted"></div>
        <button id="next">Suivant</button>
      </div>
      <div id="error" class="muted" style="color:#fecaca;margin-top:8px"></div>
    </div>
  </div>

  <script src="api.js"></script>
  <script>
    const meEl = document.getElementById('me');
    const errorEl = document.getElementById('error');
    const tbody = document.querySelector('#payments tbody');
    const pageInfo = document.getElementById('pageInfo');
    const statusSel = document.getElementById('status');
    const methodSel = document.getElementById('method');
    const refreshBtn = document.getElementById('refresh');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const logout = document.getElementById('logout');

    let currentPage = 1;
    function statusBadge(s){
      let cls, text;
      switch(s) {
        case 'completed':
        case 'success':
          cls = 'success';
          text = 'Complété';
          break;
        case 'failed':
          cls = 'failed';
          text = 'Échoué';
          break;
        case 'pending':
          cls = 'pending';
          text = 'En attente';
          break;
        default:
          cls = 'pending';
          text = s || 'Inconnu';
      }
      return `<span class="status ${cls}">${text}</span>`;
    }

    async function ensureAuth(){
      try {
        console.log('Vérification de l\'authentification...');
        const token = DonsApi.getAuthToken();
        console.log('Token stocké:', token);
        
        if (!token) {
          console.log('Pas de token, redirection vers login');
          location.href = 'login.html';
          return;
        }
        
        const me = await DonsApi.AuthApi.me();
        console.log('Utilisateur récupéré:', me);
        meEl.textContent = `Connecté: ${me.first_name || ''} ${me.last_name || ''} (${me.phone_number || ''})`;
      } catch (e) {
        console.error('Erreur d\'authentification:', e);
        console.log('Tentative de connexion sans authentification...');
        meEl.textContent = 'Mode test - Pas d\'authentification';
        // Ne pas rediriger pour le moment, juste afficher un message
      }
    }

    function renderTable(list){
      tbody.innerHTML = '';
      if (!list || list.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="7" style="text-align: center; padding: 20px; color: #666;">Aucun paiement trouvé</td>';
        tbody.appendChild(tr);
        return;
      }
      
      list.forEach(p => {
        const tr = document.createElement('tr');
        const amount = p.amount ? `${parseFloat(p.amount).toLocaleString()} FCFA` : '';
        const date = p.created_at ? new Date(p.created_at).toLocaleString('fr-FR') : '';
        
        tr.innerHTML = `
          <td><strong>${p.payment_reference || 'N/A'}</strong></td>
          <td><strong>${amount}</strong></td>
          <td>${p.payment_method || 'N/A'}</td>
          <td>${p.phone_number || 'N/A'}</td>
          <td>${statusBadge(p.status || '')}</td>
          <td>${p.user_name || 'Utilisateur inconnu'}</td>
          <td>${date}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function load(page = 1){
      errorEl.textContent = '';
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #666;">Chargement des paiements...</td></tr>';
      
      // CONNEXION À LA BASE DE DONNÉES POSTGRESQL
      console.log('Connexion à la base de données PostgreSQL...');
      
      try {
        console.log('Chargement des paiements depuis PostgreSQL, page:', page);
        
        // Appel direct à l'API PostgreSQL
        const response = await fetch('http://localhost:8000/api_payments_direct.php', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const res = await response.json();
        console.log('Réponse API paiements:', res);
        
        // Utiliser la structure de données correcte
        const payments = res?.data || [];
        const pagination = res?.pagination || {};
        
        renderTable(payments);
        currentPage = pagination?.current_page || 1;
        const total = pagination?.total_items || payments.length;
        const lastPage = pagination?.total_pages || 1;
        
        pageInfo.textContent = `Page ${currentPage} / ${lastPage} — ${total} éléments`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= lastPage;
        
        console.log(`Affichage de ${payments.length} paiements sur la page ${currentPage}`);
      } catch (err) {
        console.error('Erreur lors du chargement des paiements:', err);
        errorEl.textContent = err?.data?.message || err.message || 'Erreur de chargement des paiements';
        if (err.status === 401) { 
          location.href = 'login.html'; 
        }
      }
    }

    refreshBtn.addEventListener('click', () => load(1));
    prevBtn.addEventListener('click', () => load(Math.max(1, currentPage - 1)));
    nextBtn.addEventListener('click', () => load(currentPage + 1));
    statusSel.addEventListener('change', () => load(1));
    methodSel.addEventListener('change', () => load(1));
    logout.addEventListener('click', async (e) => { e.preventDefault(); await DonsApi.AuthApi.logout(); location.href = 'login.html'; });

    (async function init(){
      await ensureAuth();
      await load(1);
    })();
  </script>
</body>
</html>



