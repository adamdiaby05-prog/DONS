<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Connexion — DONS Admin</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="card" style="max-width:520px;margin:0 auto;">
      <div class="header">
        <h1 class="title">Connexion administrateur</h1>
      </div>
      <p class="muted">Accédez à votre tableau de bord pour consulter les paiements.</p>

      <form id="login-form" class="grid" style="margin-top:10px">
        <div>
          <label for="phone_number">Numéro de téléphone</label>
          <input id="phone_number" name="phone_number" placeholder="Ex: 690123456" autocomplete="tel" required>
        </div>
        <div>
          <label for="password">Mot de passe</label>
          <input id="password" name="password" type="password" placeholder="Votre mot de passe" required>
        </div>
        <div class="row">
          <button type="submit" id="submit">Se connecter</button>
          <a class="link right" href="signup.html">Créer un compte</a>
        </div>
        <div id="error" class="muted" style="color:#fecaca"></div>
      </form>
      <div class="footer">Besoin d'aide ? Contactez l'administrateur système.</div>
    </div>
  </div>

  <script src="api.js"></script>
  <script>
    const form = document.getElementById('login-form');
    const errorBox = document.getElementById('error');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorBox.textContent = '';
      const phone_number = document.getElementById('phone_number').value.trim();
      const password = document.getElementById('password').value;
      const btn = document.getElementById('submit');
      btn.disabled = true; btn.textContent = 'Connexion...';
      try {
        console.log('Tentative de connexion avec:', { phone_number, password: '***' });
        const res = await DonsApi.AuthApi.login({ phone_number, password });
        console.log('Réponse de connexion:', res);
        if (res && res.token) {
          console.log('Token reçu, redirection vers dashboard...');
          console.log('Token stocké:', res.token);
          DonsApi.setAuthToken(res.token);
          console.log('Token vérifié après stockage:', DonsApi.getAuthToken());
          
          // Test de l'endpoint /api/user avant redirection
          try {
            console.log('Test de l\'endpoint /api/user...');
            const me = await DonsApi.AuthApi.me();
            console.log('Test réussi:', me);
          } catch (e) {
            console.error('Test échoué:', e);
          }
          
          location.href = 'dashboard.html';
        } else {
          console.log('Pas de token dans la réponse:', res);
          throw new Error('Réponse inattendue du serveur');
        }
      } catch (err) {
        console.error('Erreur de connexion:', err);
        errorBox.textContent = err?.data?.message || err.message || 'Erreur de connexion';
      } finally {
        btn.disabled = false; btn.textContent = 'Se connecter';
      }
    });
  </script>
</body>
</html>



