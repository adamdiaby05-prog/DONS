<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin — Paiements</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container layout">
    <aside class="sidebar">
      <h2 class="brand">DONS Admin</h2>
      <nav>
        <a href="dashboard.html">Tableau de bord</a>
        <a href="admin_groups.html">Groupes</a>
        <a href="admin_members.html">Membres</a>
        <a href="admin_exports.html">Exports</a>
        <a class="active" href="admin_payments.html">Paiements</a>
      </nav>
    </aside>
    <div class="content card">
      <div class="header">
        <h1 class="title">Paiements</h1>
      </div>
      <div class="toolbar">
        <div class="row" style="gap:8px">
          <select id="status">
            <option value="">Tous statuts</option>
            <option value="pending">En attente</option>
            <option value="success">Réussi</option>
            <option value="failed">Échoué</option>
          </select>
          <select id="method">
            <option value="">Toutes méthodes</option>
            <option value="MTN">MTN</option>
            <option value="ORANGE">Orange</option>
            <option value="AIRTEL">Airtel</option>
          </select>
          <button id="refresh">Actualiser</button>
        </div>
      </div>
      <table class="table" id="payments">
        <thead>
          <tr>
            <th>Référence</th>
            <th>Montant</th>
            <th>Méthode</th>
            <th>Téléphone</th>
            <th>Statut</th>
            <th>Groupe</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <button id="prev">Précédent</button>
        <div id="pageInfo" class="muted"></div>
        <button id="next">Suivant</button>
      </div>
      <div id="error" class="muted" style="color:#ef4444;margin-top:8px"></div>
    </div>
  </div>

  <script src="api.js"></script>
  <script>
    const errorEl = document.getElementById('error');
    const tbody = document.querySelector('#payments tbody');
    const pageInfo = document.getElementById('pageInfo');
    const statusSel = document.getElementById('status');
    const methodSel = document.getElementById('method');
    const refreshBtn = document.getElementById('refresh');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    let currentPage = 1;

    function statusBadge(s){
      const cls = s === 'success' ? 'success' : (s === 'failed' ? 'failed' : 'pending');
      return `<span class=\"status ${cls}\">${s}</span>`;
    }

    function renderTable(list){
      tbody.innerHTML = '';
      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.payment_reference || ''}</td>
          <td>${p.amount != null ? p.amount : ''}</td>
          <td>${p.payment_method || ''}</td>
          <td>${p.phone_number || ''}</td>
          <td>${statusBadge(p.status || '')}</td>
          <td>${p.contribution?.group?.name || ''}</td>
          <td>${new Date(p.created_at || Date.now()).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function load(page=1){
      errorEl.textContent='';
      try{
        const res = await DonsApi.PaymentsApi.list({ status: statusSel.value || undefined, payment_method: methodSel.value || undefined, page });
        const pag = res?.payments; renderTable(pag?.data || []);
        currentPage = pag?.current_page || 1; const lastPage = pag?.last_page || 1; const total = pag?.total || 0;
        pageInfo.textContent = `Page ${currentPage} / ${lastPage} — ${total} éléments`;
        prevBtn.disabled = currentPage <= 1; nextBtn.disabled = currentPage >= lastPage;
      }catch(err){ errorEl.textContent = err?.data?.message || err.message || 'Erreur'; if(err.status===401){ location.href='login.html'; } }
    }

    refreshBtn.addEventListener('click', ()=>load(1));
    prevBtn.addEventListener('click', ()=>load(Math.max(1, currentPage-1)));
    nextBtn.addEventListener('click', ()=>load(currentPage+1));
    load(1);
  </script>
</body>
</html>


